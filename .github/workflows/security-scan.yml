name: InfraGuard Security Scan

on:
  # Run daily at 9 AM UTC in production, more frequent in dev
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to scan'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
  
  # Run on push to any branch (including main for deployment)
  push:
    branches: [ main, 'feature/**', 'plan-scanning' ]
  
  # Run on PR to main (security gate before merge)
  pull_request:
    branches: [ main ]

jobs:
  
  security-scan:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production') || 'development' }}
    permissions:
     id-token: write
     contents: read
    # Add timeout to prevent infinite runs
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Faster checkout
      
      - name: Determine Environment
        id: env
        run: |
          if [ "${{ github.event.inputs.environment }}" != "" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="development"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo " Running in $ENV environment"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cache pip dependencies
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Basic dependencies if requirements.txt doesn't exist
            pip install boto3 pandas
          fi
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # OIDC is FREE and more secure - use if role ARN is configured
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          # Fallback to access keys if OIDC not set up yet
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'eu-north-1' }}
          role-duration-seconds: 3600  # 1 hour session (FREE)
          role-session-name: GitHubActions-InfraGuard-${{ github.run_id }}
      
      - name: Run InfraGuard Security Checks
        id: scan
        env:
          INFRAGUARD_S3_BUCKET: ${{ secrets.INFRAGUARD_S3_BUCKET }}
          INFRAGUARD_SNS_TOPIC_ARN: ${{ secrets.INFRAGUARD_SNS_TOPIC_ARN }}
          INFRAGUARD_SLACK_WEBHOOK: ${{ secrets.INFRAGUARD_SLACK_WEBHOOK }}
          INFRAGUARD_LOG_LEVEL: INFO
          SCAN_ENVIRONMENT: ${{ steps.env.outputs.environment }}
        run: |
          # Create output directory
          mkdir -p ./scan-results
          
          # Set timestamp for findings file
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          FINDINGS_FILE="./scan-results/findings-${TIMESTAMP}.json"
          
          # Run security scan based on environment
          if [ "${{ steps.env.outputs.environment }}" = "production" ]; then
            echo "üîç Running PRODUCTION security scan (full scope)"
            python main.py check-all --output-file "$FINDINGS_FILE" --output-format json
          else
            echo "üîç Running DEVELOPMENT security scan (IAM + Network only)"
            # Run limited checks for dev to reduce costs
            python main.py check-iam --output-file ./scan-results/iam-${TIMESTAMP}.json --output-format json
            python main.py check-network --output-file ./scan-results/network-${TIMESTAMP}.json --output-format json
            
            # Merge findings for dev scans
            echo '{"findings": [], "scan_time": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'", "environment": "development"}' > "$FINDINGS_FILE"
            # Use the IAM results as primary (network results sent to SNS separately)
            if [ -f ./scan-results/iam-${TIMESTAMP}.json ]; then
              cp ./scan-results/iam-${TIMESTAMP}.json "$FINDINGS_FILE"
            fi
          fi
          
          # Parse findings with safe defaults
          if [ -f "$FINDINGS_FILE" ]; then
            # Count total findings (handle both array and object formats)
            TOTAL_FINDINGS=$(jq 'if type == "array" then length elif .findings then (.findings | length) else 0 end' "$FINDINGS_FILE" 2>/dev/null || echo "0")
            
            # Count critical findings
            CRITICAL_FINDINGS=$(jq '[if type == "array" then .[] elif .findings then .findings[] else empty end | select(.severity == "CRITICAL")] | length' "$FINDINGS_FILE" 2>/dev/null || echo "0")
            
            echo "‚úÖ Scan complete: $TOTAL_FINDINGS findings ($CRITICAL_FINDINGS critical)"
          else
            echo "‚ö†Ô∏è No findings file generated"
            TOTAL_FINDINGS=0
            CRITICAL_FINDINGS=0
          fi
          
          # Export for next steps
          echo "total_findings=$TOTAL_FINDINGS" >> $GITHUB_OUTPUT
          echo "critical_findings=$CRITICAL_FINDINGS" >> $GITHUB_OUTPUT
          echo "findings_file=$FINDINGS_FILE" >> $GITHUB_OUTPUT
          
          # Create GitHub Step Summary
          echo "## üìä Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ steps.env.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Findings** | $TOTAL_FINDINGS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Critical** | $CRITICAL_FINDINGS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $TIMESTAMP |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show critical findings if any
          if [ "$CRITICAL_FINDINGS" -gt 0 ]; then
            echo "### ‚ö†Ô∏è Critical Issues Found:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            jq -r '[if type == "array" then .[] elif .findings then .findings[] else empty end | select(.severity == "CRITICAL")] | .[] | "- **\(.category)**: \(.description)"' "$FINDINGS_FILE" >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "- Could not parse critical findings" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ No Critical Issues" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload findings as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-findings-${{ github.run_number }}-${{ github.sha }}
          path: |
            ./scan-results/
            !./scan-results/temp-*
          retention-days: 90  # Keep for compliance
          if-no-files-found: warn
      
      - name: Security Gate - Fail on Critical Findings
        if: ${{ github.event_name == 'pull_request' || github.ref == 'refs/heads/main' }}
        run: |
          if [ "${{ steps.scan.outputs.critical_findings }}" -gt 0 ]; then
            echo "::error::‚ùå Critical security findings detected! Blocking deployment."
            echo "Number of critical issues: ${{ steps.scan.outputs.critical_findings }}"
            exit 1
          else
            echo "‚úÖ No critical security findings detected."
          fi
      
      - name: Send Slack Notification
        if: always() && env.SLACK_WEBHOOK_URL
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "InfraGuard Security Scan ${{ job.status == 'success' && '‚úÖ Completed' || '‚ùå Failed' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": " InfraGuard Security Scan ${{ job.status == 'success' && 'Completed' || 'Failed' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ steps.env.outputs.environment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Total Findings:*\n${{ steps.scan.outputs.total_findings }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Critical Findings:*\n${{ steps.scan.outputs.critical_findings }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Run Details:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.INFRAGUARD_SLACK_WEBHOOK }}
  
  deploy-terraform:
    needs: security-scan
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' &&
      needs.security-scan.result == 'success'
    runs-on: ubuntu-latest
    environment: production
    
    # Add concurrency to prevent parallel deployments
    concurrency: 
      group: production-deploy
      cancel-in-progress: false
    
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false
      
      - name: Configure AWS Credentials for Terraform
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # OIDC (FREE & recommended) - works if role-to-assume is set
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          # Fallback to dedicated Terraform access keys
          aws-access-key-id: ${{ secrets.TERRAFORM_AWS_ACCESS_KEY_ID || secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.TERRAFORM_AWS_SECRET_ACCESS_KEY || secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'eu-north-1' }}
          role-session-name: GitHubActions-Terraform-${{ github.run_id }}
      
      - name: Terraform Init
        run: terraform init -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" -backend-config="key=infraguard/terraform.tfstate" -backend-config="region=eu-north-1"
        working-directory: ./terraform
      
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ./terraform
      
      - name: Terraform Validate
        run: terraform validate
        working-directory: ./terraform
      
      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -out=tfplan -var="environment=production" -var="github_sha=${{ github.sha }}"
          # Capture plan output for review
          terraform show -json tfplan > tfplan.json
        working-directory: ./terraform
      
      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.run_number }}
          path: ./terraform/tfplan.json
          retention-days: 7
      
      - name: Scan Terraform Plan (Shift-Left Security)
        id: plan-scan
        run: |
          echo "üîç Scanning Terraform plan for security issues BEFORE deployment..."
          
          # Run plan-time security scan
          python main.py scan-plan --plan-file terraform/tfplan.json --output-file plan-scan-results.json --output-format json
          
          # Parse findings
          PLAN_TOTAL=$(jq 'if type == "array" then length elif .findings then (.findings | length) else 0 end' plan-scan-results.json 2>/dev/null || echo "0")
          PLAN_CRITICAL=$(jq '[if type == "array" then .[] elif .findings then .findings[] else empty end | select(.severity == "CRITICAL")] | length' plan-scan-results.json 2>/dev/null || echo "0")
          PLAN_HIGH=$(jq '[if type == "array" then .[] elif .findings then .findings[] else empty end | select(.severity == "HIGH")] | length' plan-scan-results.json 2>/dev/null || echo "0")
          
          echo "total_findings=$PLAN_TOTAL" >> $GITHUB_OUTPUT
          echo "critical_findings=$PLAN_CRITICAL" >> $GITHUB_OUTPUT
          echo "high_findings=$PLAN_HIGH" >> $GITHUB_OUTPUT
          
          # Create summary
          echo "## üõ°Ô∏è Terraform Plan Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **CRITICAL** | $PLAN_CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| **HIGH** | $PLAN_HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | $PLAN_TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$PLAN_CRITICAL" -gt 0 ] || [ "$PLAN_HIGH" -gt 0 ]; then
            echo "### ‚ö†Ô∏è Issues Found in Planned Changes:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            jq -r '[if type == "array" then .[] elif .findings then .findings[] else empty end | select(.severity == "CRITICAL" or .severity == "HIGH")] | .[] | "- **[\(.severity)] \(.category)**: \(.description)"' plan-scan-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
          else
            echo "### ‚úÖ No Critical or High Issues in Planned Changes" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "‚úÖ Plan scan complete: $PLAN_TOTAL findings ($PLAN_CRITICAL critical, $PLAN_HIGH high)"
      
      - name: Upload Plan Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: plan-scan-results-${{ github.run_number }}
          path: plan-scan-results.json
          retention-days: 90
      
      - name: Security Gate - Block Deployment on Critical Plan Issues
        if: steps.plan-scan.outputs.critical_findings != '0'
        run: |
          echo "::error::‚ùå CRITICAL security issues detected in Terraform plan! Blocking deployment."
          echo "Critical issues in planned changes: ${{ steps.plan-scan.outputs.critical_findings }}"
          echo ""
          echo "These issues would be INTRODUCED by this deployment:"
          jq -r '[if type == "array" then .[] elif .findings then .findings[] else empty end | select(.severity == "CRITICAL")] | .[] | "- \(.resource): \(.description)\n  Recommendation: \(.recommendation)"' plan-scan-results.json || true
          exit 1
      
      - name: Clean Terraform State (remove deleted secrets)
        continue-on-error: true
        run: |
          echo "Checking secret status in AWS..."
          
          # Check if secret is scheduled for deletion
          SECRET_STATUS=$(aws secretsmanager describe-secret \
            --secret-id infraguard/scanner-credentials \
            --region ${{ vars.AWS_REGION || 'eu-north-1' }} \
            2>&1 || echo "NOT_FOUND")
          
          if echo "$SECRET_STATUS" | grep -q "DeletionDate"; then
            echo "‚ö†Ô∏è Secret is scheduled for deletion. Restoring and force-deleting..."
            
            # Restore the secret
            aws secretsmanager restore-secret \
              --secret-id infraguard/scanner-credentials \
              --region ${{ vars.AWS_REGION || 'eu-north-1' }} 2>/dev/null || echo "Could not restore"
            
            sleep 2
            
            # Force delete immediately
            aws secretsmanager delete-secret \
              --secret-id infraguard/scanner-credentials \
              --force-delete-without-recovery \
              --region ${{ vars.AWS_REGION || 'eu-north-1' }} 2>/dev/null || echo "Could not delete"
            
            sleep 3
            
            # Remove from Terraform state
            terraform state rm module.iam.aws_secretsmanager_secret.infraguard_credentials || true
            
            echo "‚úÖ Cleaned up secret scheduled for deletion"
            
          elif echo "$SECRET_STATUS" | grep -q "ResourceNotFoundException"; then
            echo "Secret doesn't exist in AWS, removing from Terraform state..."
            terraform state rm module.iam.aws_secretsmanager_secret.infraguard_credentials || true
            
          else
            echo "‚úÖ Secret exists and is not scheduled for deletion"
          fi
        working-directory: ./terraform
      - name: Terraform Apply (Auto-approve for main branch)
        if: github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve tfplan
        working-directory: ./terraform
      
      - name: Post-deployment validation
        run: |
          # Run network security scan after deployment
          echo "üîç Running post-deployment security validation..."
          python main.py check-network --output-file post-deploy-scan.json --output-format json
          
          # Check for any critical issues
          CRITICAL_COUNT=$(jq 'if type == "array" then [.[] | select(.severity == "CRITICAL")] | length elif .findings then [.findings[] | select(.severity == "CRITICAL")] | length else 0 end' post-deploy-scan.json 2>/dev/null || echo "0")
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::error::‚ùå Critical security issues detected after deployment!"
            echo "Critical issues found: $CRITICAL_COUNT"
            jq -r '[if type == "array" then .[] elif .findings then .findings[] else empty end | select(.severity == "CRITICAL")] | .[] | "- \(.category): \(.description)"' post-deploy-scan.json
            exit 1
          else
            echo "‚úÖ Post-deployment validation passed"
          fi